name: packetfence_perl_rhel8_package
on:
  push:
    branches-ignore: 
      - 'devel'   # excludes devel
    paths:
      - 'addons/packetfence-perl/**'
      - '.github/workflows/docker-packetfence-perl-rhel8.yml'
      - 'containers/packetfence-perl/rhel8/**'
  schedule:
    - cron: 0 3 * * *
  pull_request:
    branches: [ "devel" ]
    paths:
      - 'addons/packetfence-perl/**'

env:
  WORKDIR: "/root"
  VOLUME_MOUNT: "/mnt/${{ github.run_id }}_${{ github.run_attempt }}"
  OUTPUT_DIRECTORY: "/mnt/output/"
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_image:
    runs-on: packetfence-perl-rpm-package-build
    permissions:
      contents: read
      packages: write
      # This is used to complete the identity challenge
      # with sigstore/fulcio when running outside of PRs.
      id-token: write
    outputs:
      package_version: ${{ steps.contents.outputs.data }}
      VOLUME_MOUNT: ${{ steps.contents.outputs.volume_mount }}
      OUTPUT_DIRECTORY: ${{ steps.contents.outputs.output_directory }}
      WORKDIR: ${{ steps.contents.outputs.workdir }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3    

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host

      - name: Declare output variable
        id: contents
        run: |
          package_version=$(set -e && docker run --rm -i -v ${{ github.workspace }}/addons/packetfence-perl:${{ env.WORKDIR }}/ rockylinux:8.8 /bin/bash -c \
          "set -e && cd ${{ env.WORKDIR }}/ && yum -y  install rpm-build > /dev/null 2>&1 && rpmspec -q --qf "%{version}"  rhel8/SPECS/packetfence-perl.spec")
          echo "Found version: $package_version"
          echo "PACKAGE_VERSION=$package_version" >> "$GITHUB_ENV"
          echo "data=$package_version" >> "$GITHUB_OUTPUT"
          echo "volume_mount=${{env.VOLUME_MOUNT}}" >> "$GITHUB_OUTPUT"
          echo "output_directory=${{env.OUTPUT_DIRECTORY}}" >> "$GITHUB_OUTPUT"
          echo "workdir=${{env.WORKDIR}}" >> "$GITHUB_OUTPUT"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ vars.USER_GITHUB }}
          password: ${{ secrets.TOKEN_GITHUB }}
  
      - name: Build packetfence-perl docker image
        uses: docker/build-push-action@v5
        with:
          context: './'
          push: true
          secrets: |
            PSONO_API_KEY_ID=${{ secrets.PSONO_API_KEY_ID }}
            PSONO_API_KEY_SECRET_KEY=${{ secrets.PSONO_API_KEY_SECRET_KEY }}
          build-args: |
            workdir=${{ env.WORKDIR }}
            output_directory=${{ env.OUTPUT_DIRECTORY }}
            psono_nqb_rhel_subs_secret_id=${{ vars.PSONO_NQB_RHEL_SUBS_SECRET_ID }}
          tags: |
            ghcr.io/inverse-inc/packetfence/packetfence-perl-rhel8:${{ env.PACKAGE_VERSION }}
            ${{ env.BRANCH_NAME == 'devel' && 'ghcr.io/inverse-inc/packetfence/packetfence-rhel8:latest' || ''}}
          file: containers/packetfence-perl/rhel8/Dockerfile_rhel8



  build_package:
    needs: ['build_image']
    runs-on: packetfence-perl-rpm-package-build
    container:
      image: ghcr.io/inverse-inc/packetfence/packetfence-perl-rhel8:${{ needs.build_image.outputs.package_version }}
      credentials:
        username: ${{ vars.USER_GITHUB }}
        password: ${{ secrets.TOKEN_GITHUB }}
      volumes:
        - ${{ github.workspace }}/addons/packetfence-perl/:${{ needs.build_image.outputs.WORKDIR  }}
        - ${{ needs.build_image.outputs.VOLUME_MOUNT }}:${{ needs.build_image.outputs.OUTPUT_DIRECTORY }}
    steps:     
      - name: Build package
        run: |
          cd /root
          set -e && python3 install_cpan.py -d dependencies.csv -vi true && ./build_package.sh
          ls -la ${{ env.OUTPUT_DIRECTORY }}/rhel8/packages/
        
  unit-test:
    needs: ['build_image', 'build_package']
    runs-on: packetfence-perl-rpm-package-build
    container:
      image: redhat/ubi8
      volumes:
        - ${{ needs.build_image.outputs.VOLUME_MOUNT }}/rhel8/packages/:/mnt
    steps:     
      - name: Install the package packetfence-perl
        run: |
          yum -y install findutils 
          ls -la /mnt
          find /mnt -name "packetfence-perl-*.rpm" -exec rpm -ivh {} \;


  sign_package:
    needs: ['build_image', 'unit-test', 'build_package']
    runs-on: packetfence-perl-rpm-package-build
    container:
      image: rockylinux:8.8
      volumes:
        - ${{ needs.build_image.outputs.VOLUME_MOUNT }}/rhel8/packages/:/mnt
    steps:
      - name: Install dependenecies
        run: yum install -y rpm-sign

      - name: import private key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --pinentry-mode loopback --import

      - name: Check if the key was imported
        run: |
          rpm -q gpg-pubkey --qf '%{name}-%{version}-%{release} --> %{summary}\n'
          gpg --list-keys

      - name: Sign the package
        run: rpm --define "_gpg_name support@inverse.ca" --define '_signature gpg' --addsign  /mnt/packetfence-perl*.rpm

      - name: Verifiy the signarure of package
        run: |
          gpg  --batch --yes   --output /tmp/pubkey.pub --armor --export  support@inverse.ca && rpm --import /tmp/pubkey.pub
          rpm -qpi /mnt/packetfence-perl*.rpm
          rpm --checksig /mnt/packetfence-perl*.rpm

  upload-package: 
    needs: ['build_image', 'unit-test', 'sign_package', 'build_package']
    runs-on: packetfence-perl-rpm-package-build

    env:
      PACKAGE_DEST_PATH: /root/packages/packetfence-perl/${{ github.head_ref || github.ref_name }}/rhel8/v_${{ needs.build_image.outputs.package_version }}/

    steps:
    - name: Upload the package to web server
      run: |
        echo "The package will be uploaded to the web server, directory: ${{ env.PACKAGE_DEST_PATH }}"
        set -e && \
        eval `ssh-agent -s` && ssh-add - <<< $(echo "${{ secrets.DEPLOY_KEY_WEB_SERVER }}") && \
        rsync -avzr --delete --rsync-path='mkdir -p  ${{ env.PACKAGE_DEST_PATH }} && rsync' -e "ssh -o StrictHostKeyChecking=no -p 22"  ${{ env.VOLUME_MOUNT }}/rhel8/packages/packetfence-perl-*.rpm root@192.95.20.194:${{ env.PACKAGE_DEST_PATH }}
        ssh-add -D

    - name: Remove files
      uses: addnab/docker-run-action@v3
      with:
        image: rockylinux:8.8
        options: --rm -v /mnt:/mnt
        shell: /bin/bash
        run: |
          rm -rf ${{ env.VOLUME_MOUNT }}
